(function(a){a.fn.commentify=function(r){var b=a.extend(true,{},{autoCreateTags:true,infiniteLoad:false,liveTiming:false,liveTimingInterval:30000,pageCount:10,api:{add:{url:"/api/add-comment",method:"post",dataType:"json"},get:{url:"/api/get-comments",method:"get"}},fields:{name:true,email:true,comment:true},ids:{name:"commentify-name",email:"commentify-email",comment:"commentify-comment",button:"commentify-button",message:"commentify-message",loadMore:"commentify-load-more",commentsContainer:"commentify-comments"},classes:{name:"commentify-name",email:"commentify-email",comment:"commentify-comment",date:"commentify-date",button:"commentify-button",form:"commentify-form",loadMore:"commentify-load-more",commentsContainer:"comments-container",commentBox:"commentify-comment-box"},texts:{name:"Full Name",email:"Email address",comment:"Enter your comment here",button:"Comment",loadMore:"Load more comments",success:"Thank you for your comment!",error:"OOPS, Something is wrong! Please try again latter"},events:{onNewComment:a.noop,onNewCommentSuccess:a.noop,onNewCommentError:a.noop,onLoadComment:a.noop}},r);var d=0,n=0,m,i=false;if(b.autoCreateTags){this.html("<div class='"+b.classes.form+"'><input id='"+b.ids.name+"' type='text' class='"+b.classes.name+"' placeholder='"+b.texts.name+"' /><input id='"+b.ids.email+"' type='email' class='"+b.classes.email+"' placeholder='"+b.texts.email+"' /><textarea id='"+b.ids.comment+"' class='"+b.classes.comment+"' placeholder='"+b.texts.comment+"'></textarea><button id='"+b.ids.button+"' class='"+b.classes.button+"'>"+b.texts.button+"</button><span id='"+b.ids.message+"'></span></div><div id='"+b.ids.commentsContainer+"' class='"+b.classes.commentsContainer+"'> </div><div id='"+b.ids.loadMore+"' class='"+b.classes.loadMore+"'><span>"+b.texts.loadMore+"</span></div>")}var c=a("#"+b.ids.name,this),k=a("#"+b.ids.email,this),h=a("#"+b.ids.comment,this),q=a("#"+b.ids.message,this),e=a("#"+b.ids.commentsContainer,this);a("#"+b.ids.button,this).on("click",function(){b.events.onNewComment();f()});a("#"+b.ids.loadMore,this).on("click",function(){l()});if(b.infiniteLoad){a(window).scroll(function(){if(!i&&j("#"+b.ids.loadMore)){l()}})}var l=function(){i=true;b.events.onLoadComment();var s=d*b.pageCount;a.get(b.api.get.url+"?count="+b.pageCount+"&from="+s,function(v){v=a.parseJSON(v);var u="";for(var t=0;t<v.length;t++){u+=p(v[t])}e.append(u);d++;if(v.length<b.pageCount){a("#"+b.ids.loadMore).hide()}if(b.liveTiming){g()}}).always(function(){i=false})};var f=function(){var s={name:c.val(),email:k.val(),comment:h.val()};a.ajax({url:b.api.add.url,method:b.api.add.method,data:s,dataType:b.api.add.dataType}).success(function(t){if(t.status=="success"){b.events.onNewCommentSuccess(t);c.val("");k.val("");h.val("");q.text(b.texts.success);s.submitdate=new Date().toUTCString();e.prepend(p(s));g()}else{b.events.onNewCommentError(s);q.text(b.texts.error)}}).error(function(t){b.events.onNewCommentError(t);q.text(b.texts.error)})};var p=function(s){return"<div class='"+b.classes.commentBox+"'><span class='"+b.classes.name+"'>"+s.name+"</span><span class='"+b.classes.date+"'><span>"+o(s.submitdate)+"</span><input type='hidden' value='"+s.submitdate+"'/></span><p class='"+b.classes.comment+"'>"+s.comment+"</p></div>"};var o=function(u){var s=new Date(u),v=(((new Date()).getTime()-s.getTime())/1000),t=Math.floor(v/86400);if(isNaN(t)||t<0||t>=31){return}return t==0&&(v<60&&"just now"||v<120&&"1 minute ago"||v<3600&&Math.floor(v/60)+" minutes ago"||v<7200&&"1 hour ago"||v<86400&&Math.floor(v/3600)+" hours ago")||t==1&&"Yesterday"||t<7&&t+" days ago"||t<31&&Math.ceil(t/7)+" weeks ago"};var g=function(){m=new Array();a("."+b.classes.date).each(function(){var s=a(this);var t=s.find("input").val();m.push({date:t,tag:s.find("span")})});if(n){clearInterval(n)}n=setInterval(function(){for(var s=0;s<m.length;s++){m[s].tag.text(o(m[s].date))}},b.liveTimingInterval)};var j=function(u){var w=a(window).scrollTop();var t=w+a(window).height();var v=a(u).offset().top;var s=v+a(u).height();return((s<=t)&&(v>=w))};l();return this}}(jQuery));